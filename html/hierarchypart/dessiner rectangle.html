<html>

    <head>  

        <script src="js/profondeur et largeur.js"></script>
        <script src="js/draw.js"></script>
        <script src="js/cacher_rect.js"></script>
        <script src="js/parcourire d3js.js"></script>
        <link rel="stylesheet" type="text/css" href="csss.css">
       <link rel="stylesheet" type="text/css" href="css/css.css">
  <script src="https://d3js.org/d3.v5.min.js"></script>
    </head>
    
    <body>
   		voir logs console
   		<div>
   			<svg>
   				<g ><rect width=50 height=15 y=15 ></rect>
   				
   				
	   				<g class="parent" ><rect width=50 height=15 y=32></rect>
	   					<g><rect width=50 height=15 y=49></rect>
	   						<g><rect width=50 height=15 y=66></rect></g>
	   					</g>
	   					
	   				</g>
	   				
	   				
	   				
	   				
	   				<g ><rect width=50 height=15 y=32 x="60"></rect>
	   					<g><rect width=50 height=15 y=49 x="60"></rect>
	   						<g><rect width=50 height=15 y=66 x="60"></rect></g>
	   					</g>
	   					
	   					
	   					
	   				</g>
	   			</g>
   			</svg>
   		</div>
   		<button onclick="f_essai()">Click me</button>
   		<input id="text">
        <div id="timeline"></div>
        <div class="tooltip"></div>
            <div id="hierarchypart"> </div>
            <div id="hierarchypart2"> </div>
    </body>

    <script>
    
    	let rect = d3.selectAll("rect");
		
		rect.on("click", function(){
			let g = d3.select(d3.select(this).node().parentNode);
			g.attr("class","fill-blue");
			if (["fill-blue"].includes(g.attr("class")) ){
				console.log("in");
			}
    	})
    
		// Selectionner le parent
		let p = d3.select(".parent");

		
		//Pour tout les noeuds
		let noeud = p.selectAll("g");
		
		//Changer l'attribut

		
		//Recuperer les enfants
		let enfant = p;
		
		//Pour chaque parent positionner en bas (noeud = hauteur = y)
		/*enfant.each(function(e,i){
			let d = d3.select(enfant[i]);
			d.attr("x");
			console.log(e);
		});*/
			//Pour chaque noeuds
				//positionner à droite (noeud = profondeur = x)

		//Quand on clique sur le neoud parrent
			//Pour le parent
			//&&
			//Pour tout les enfants des enfants
				//On ajoute une position a son attribut
		
				

		//Selectionner tout les rectangle
console.log(d3.selectAll("rect"));
		d3.selectAll("rect")
		.call(d3.drag()

        .on("drag", dragged));


function dragged(d) {
			//console.log(d3.select(".parent").node());
			let position = d3.mouse(this);
			//console.log(d3.select(this).node().parentNode);
			d3.select(d3.select(this).node().parentNode)
			.attr("transform", "translate("+event.x+","+event.y+")")
			//console.log(d3.select(this).node().parentNode);
}


    	var file = "mocks/mock2.json"; // Chemin du fichier json
    	var hierarchypart = svg("#hierarchypart",window.innerWidth,3000); // selection d'un svg sur l'id hierarchypart
    	var hierarchypart2 = svg("#hierarchypart2",window.innerWidth,3000); // selection d'un svg sur l'id hierarchypart
    	
    	var element = hierarchypart.append("g"); // ajout dans cette hierarchypart une DIV "g" afin de grouper
    	var element2 = hierarchypart.append("g"); // ajout dans cette hierarchypart une DIV "g" afin de grouper
    	var w = h = 10;
    	/*
    	var treemap = d3.treemap()
        .round(false)
        .size([w, h])
        .sticky(true)
//        .value(function(d) { return d["???"]; });
        .value(function(d) { return d.total; });
        */
       
    	d3.json(file).then(function(data) {
			
    		/*
    		VARIABLE
    		*/
			let tableau; // variable temporaire
      	  	let nodelist = data['ownerlist'][0]['nodelist']; // variable temporaire indiquant le sommet (nodelist)
      	  	let nodelist2 = data['ownerlist'][0]['nodelist'][0];
      	  	
      	  let root = d3.hierarchy(nodelist2);
      	d3_Parcourir(root);
      	let tree = d3.partition();
      	tree(root);
      	console.log(tree.size());
      	tree.size([100,50]);
      	  //Recuperer toutes les feuilles
      	  let leaves = root.leaves();
      
      	  //Pour toutes les feuilles on recherche tout ses ancetres
      	  //On ajoute 1
      let root_leaves = leaves.map(m => {
    	  
    	  // recupere les ancetres
    	  let ancetre = m.ancestors();
    	  
    	  
    	  /*
    	  Modifier l'objet
    	  Pour chaque ancetre
    	  Ajouter 1
    	  */
    	  ancetre.map(ancetre => {
    		 
    		  if (ancetre.feuilles){
    			  ancetre.feuilles += 1;
      		  } else {
      			ancetre.feuilles = 1;
      		  }

    		  return ancetre;
    	  });
    	  
    	  
    	  //Retourne l'objet modifier
    	  return m;
      });
      	  
      let body = d3.select("body");
      let svg =  body.append("svg");
      let g = svg.append("g");
 	let uneConstante = 15;

      let root_data = root.data;
      let root_child = root.children;

      let root_array = Object.values(root_child);
      console.log("pass");
      
      //Parcourir en profondeur
      parcourire_arbre(root);
      
      //console.log("*",d3.select("body").data(d3.select(root)));

      //console.log("r",root.descendants());
/*
      		  */
//console.log(leaves[0]);
      	  
      	/*root.descendants()
      	//Largeur
      	height = nombre d'enfant + 1
      	depth = profondeur + 1
      	  */
      	  	// Parcourre en profondeur
      	  /*	let tree = treemap.nodes(nodelist2)
            .filter(function(d) {
            	console.log(d.children);
            	return d.children; 
            	});
*/
      	  
      	  	
      	  	/*
			function d3_essai(){
				let listeObjects = nodelist;
				let un_i = 0;
      	  		for (i = 0; i< 4; i++)
      	  			{
      	  		un_i += 1;
      	  		//console.log(nodelist);
      	  		
      	  	console.log("uneListe",listeObjects);
		      	  		var smallData = listeObjects.map(function(d,i) {
		      	  				let nbr_feuilles = 0;
		      	  				let tmp_list;
		      	  				let tmp_int;
		      	  				//Sur un objet
		      	  				//le convertire en tableau
		      	  				tmp_list = Object.values(d);
		      	  				
		      	  				//filtrer ses tableau
		      	  				tmp_list = tmp_list.filter(f => f.constructor.name =="Array");
		      	  				//recuperer leurs taille
		      	  				try {
		      	  					nbr_feuilles = tmp_list[0].length;
		      	  				} catch (e){
		      	  				nbr_feuilles = 1;
		      	  				}
		      	  				
		      	  				
		      	  				//Sur un objet
		      	  				//Ajouter des parametres
				      		  	Object.assign(d,{hauteur: i+1,
				      		  					profondeur: un_i,
				      		  					feuilles: nbr_feuilles});
		      	  				
		      	  				//Transforme l'objet en liste
								let uneListe = Object.values(d);
		      	  				
		      	  				//Dans cette liste on recupere seulement les listes
				      			uneListe = uneListe.filter(f => f.constructor.name == "Array");
				      			//console.log(d,uneListe);
		      	  				//on l'ajoute a la listeObjects
				      			return uneListe[0];
		      	  				//console.log(listeObjects);
				      		  //a.push(uneListe);
				      	  });
		      	  		//console.log("a",smallData[0]		
		      	  	listeObjects = smallData[0];
		      	  	console.log("une passe");
      	  			}
				
      	  	}
      	
			d3_essai();
			*/
		  	//console.log(nodelist);
      	  	/*
    		FONCTION			Parcour en largeur sur le sommet nodelist
    		*/
    		//parcourire_arbre(nodelist);
    		
      	  	//console.log(nodelist);

		  	tableau = nodelist; // tableau vaut la sortie de la fonction branche_niveau
	
    		
    		
    		
    		/*
    		FONCTION			position_x rectangle
    		*/
    		
    		/*
    		FONCTION			position_y rectangle
    		*/
    		/*

    		
    		*/
    		
    		
    		

    			
			/*
    		JEU D'ESSAI			branche_niveau
    		*/
			let tabl = tableau;
    		let width_max = 500; 		// largeur maximum
    		let hight_max = 250; 		// hauteur maximum
    		let parent = 0;
    		let c = 15;
    		let x = 0;
    		let y = 0;
    		let profondeur;
			let uid;
			let hauteur;
			let feuilles_noeud;
	
			let constante;
			

    		function redessiner(cnst, tabl){
    			let constante = cnst;
    			for (i = 1;i < cnst+1;i++){
    				
    				if (i > cacher_parent){
    		
    				}
        			//creation du rectangle
        			if (!cacher_niveau.includes(i)){
        				create_rect(tabl);
        			}
    				
        			parent = width[0];
        			x += width[1];
        			
        			//pour chaque element tableau
        			let m = [];
        			for (e in tabl){
        				let profondeur = tabl[e].profondeur+";"+tabl[e].hauteur;
        				if (cacher_branche.includes(profondeur)){

                		} else {
                			
                			m = m.concat(Object.values(tabl[e]));
          
                		}
        			}

        			//let m = tabl.map(mp => Object.values(mp));

        			//console.log(profondeur + ";" + hauteur, cacher);
        			
        			
        			let qsdfsdf = [];
        			
        			                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
    
      
        			tabl = m.filter(f => f.constructor.name == "Array")
        			tabl = tabl.flat();
  

        			
        			//renvoyer tableau
      
        			y = 0;
    			}

    			
    			
    			
    		}
    		
    		
    		
    		
    		redessiner(3);
			
    		function create_rect(sommet){

    			sommet.forEach(function(e){
    				if (e){
    					profondeur = e.profondeur;
        				uid = e.uid;
        				hauteur = e.hauteur;
        				feuilles_noeud = e.feuilles_noeud;
        				width = largeur_rect(constante-profondeur+1, width_max, parent, feuilles_noeud); // largeur d'une part
        				
      
        				hight =  hauteur_rect(feuilles_noeud, c);	// hauteur d'une part
        				
        				
        				//console.log(profondeur, width, parent);
        				rectangle(element,x,y,width[1],hight, profondeur+ ";" + hauteur,uid);
        				text(element, uid,x,y);
    				} else {
    					console.log("nok");
    				}
    				
    				
    				y += hight;
    				
    			});
    			
    		}

	
      	});

   </script>

</html>